<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
	<script>
		if (localStorage.theme === 'dark') {
			document.documentElement.classList.add('dark');
		}
	</script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			darkMode: 'class'
		}
	</script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Barcade Dashboard</title>
	<script src="https://unpkg.com/htmx.org@1.9.10" defer></script>

</head>
<body class="bg-gray-100 dark:bg-gray-900 text-black dark:text-white min-h-screen font-sans">
	<header class="bg-blue-800 dark:bg-blue-900 text-white p-4 shadow
               relative min-h-14
               flex flex-col gap-2
               sm:flex-row sm:items-center sm:justify-between">
		<div class="flex items-center h-8">
		{% if has_logo %}
			<img src="/static/images/logo.png" alt="Barcade Logo" class="h-8 w-auto">
		{% else %}
			<h1 class="text-xl font-semibold">Barcade Management</h1>
		{% endif %}
		</div>
		<div id="location-selector-container"
			class="relative w-full order-3
					md:order-none md:absolute md:left-1/2 md:-translate-x-1/2 md:w-auto
					px-0 md:px-0 z-10"
			hx-get="/location-selector"
			hx-trigger="load"
			hx-swap="innerHTML">
		</div>


		<div class="flex items-center gap-4 flex-wrap justify-end">
		{% if user %}
		<div class="flex items-baseline gap-2">
			<span class="font-semibold leading-none whitespace-nowrap">{{ user.name }}</span>
			<span class="text-xs font-semibold uppercase leading-none whitespace-nowrap
				{% if user.role.value == 'admin' %} text-red-500 dark:text-red-400
				{% elif user.role.value == 'user' %}  text-green-500 dark:text-green-400
				{% else %}                           text-gray-400
				{% endif %}
			">
				{% if user.role.value == "admin" %}ADMIN{% else %}{{ user.role.value|upper }}{% endif %}
			</span>
		</div>
			{% if user.role.value == "admin" %}
			<button
				hx-get="/settings/modal"
				hx-target="#modal-container"
				hx-swap="innerHTML"
				class="h-8 inline-flex items-center px-3 rounded ml-2 font-semibold text-sm bg-white text-blue-800 hover:bg-gray-200">
				Settings
			</button>
			{% endif %}
			<a href="/logout"
			class="h-8 inline-flex items-center px-3 rounded ml-2 font-semibold text-sm bg-white text-blue-800 hover:bg-gray-200">
			Logout
			</a>

			{% else %}
				<form method="post" action="/login" class="flex items-center gap-2">
				<input name="pin" type="password" placeholder="Enter PIN" maxlength="4"
					class="h-8 px-2 rounded text-black text-sm leading-none" required>
				<button type="submit"
					class="h-8 inline-flex items-center px-3 rounded font-semibold text-sm bg-white text-blue-800">
					Login
				</button>
				</form>
			{% endif %}

			<button onclick="toggleDarkMode()" class="text-white hover:text-gray-300 text-xl ml-4">
				<i class="fa-solid fa-moon block dark:hidden"></i>
				<i class="fa-solid fa-sun hidden dark:block"></i>
			</button>
		</div>
	</header>
	<main class="p-6">
		{% block content %}{% endblock %}
	</main>
	<div id="toast"
     class="absolute right-4 mt-4 space-y-2 pointer-events-none"
     style="top: 4rem;">
	</div>
	<div id="modal-container"></div>
	<script>
		function toggleDarkMode() {
			const html = document.documentElement;
			const isDark = html.classList.contains('dark');

			if (isDark) {
				html.classList.remove('dark');
				localStorage.theme = 'light';
			} else {
				html.classList.add('dark');
				localStorage.theme = 'dark';
			}
		}

		// Simple toast
		function showToast(message) {
			const wrap = document.getElementById('toast');
			const el = document.createElement('div');
			el.className = "pointer-events-auto bg-green-600 text-white px-4 py-2 rounded shadow";
			el.textContent = message || "Saved";
			wrap.appendChild(el);
			setTimeout(() => {
				el.classList.add('opacity-0');
				el.classList.add('transition-opacity');
				setTimeout(() => el.remove(), 300);
			}, 2000);
		}

		document.body.addEventListener('htmx:afterOnLoad', function (evt) {
			try {
			const xhr = evt.detail && evt.detail.xhr;
			if (!xhr) return;

			// Only react to /game/{id}/move responses
			const url = (xhr.responseURL || '');
			if (!url.includes('/game/') || !url.includes('/move')) return;

			// Try to read JSON and decide
			const text = xhr.responseText || '';
			if (!text) return;

			let data;
			try { data = JSON.parse(text); } catch { return; }

			if (data && data.unchanged) {
				// No toast when nothing moved
				return;
			}
			if ((data && (data.moved || data.swapped))) {
				// Show success toast only when a move/swap actually happened
				showToast('Position updated');
			}
			} catch (e) {
			// fail-quietly; no toast is better than a broken header
			}
		});

		// Event listener for saving a location
		document.addEventListener('location_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = {
				action: 'openSettings',
				toastMessage: message
			};
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});

		// Event listener for saving a game
		document.addEventListener('game_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = {
				action: 'openSettings',
				toastMessage: message,
				tab: 'games'
			};
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});

		// --- NEW: Event listener for saving a user ---
		document.addEventListener('user_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = {
				action: 'openSettings',
				toastMessage: message,
				tab: 'users'
			};
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});


		// HTMX custom event handler for simple saves (no reload)
		document.addEventListener('settings_saved', function (e) {
			const msg = (e && e.detail && e.detail.message) ? e.detail.message : "Settings saved";
			showToast(msg);
		});

		//HTMX custom event handler for revenue logging
		document.addEventListener('revenue_logged', function (e) {
			const msg = (e && e.detail && e.detail.message) ? e.detail.message : 'Revenue logged';
			if (window.showToast) showToast(msg);
  		});


		// Script to run on page load to check session storage
		document.body.addEventListener('htmx:load', () => {
			const postReloadData = sessionStorage.getItem('postReload');

			if (postReloadData) {
				sessionStorage.removeItem('postReload');
				const data = JSON.parse(postReloadData);

				if (data.action === 'openSettings') {
					htmx.ajax('GET', '/settings/modal', '#modal-container');
				}

				setTimeout(() => {
					if (data.tab) {
						const tabButton = document.getElementById(`settings-tab-${data.tab}`);
						if (tabButton) {
							tabButton.click();
						}
					}
					if (data.toastMessage) {
						showToast(data.toastMessage);
					}
				}, 200);
			}
		});

		// Listener for the Escape key
		document.addEventListener('keydown', function (event) {
			if (event.key === 'Escape') {
				const modal = document.getElementById('modal-container');
				if (modal) {
					modal.innerHTML = '';
				}
			}
		});

	// Close modal on HX-Trigger "close_modal"
	document.addEventListener('close_modal', function () {
		const mc = document.getElementById('modal-container');
		if (mc) mc.innerHTML = '';
	});

	// Ensure HTMX processes freshly injected modal HTML
	document.body.addEventListener("htmx:afterSwap", function (evt) {
		if (evt.detail.target && evt.detail.target.id === "modal-container") {
			htmx.process(evt.detail.target);
		}
	});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</body>
</html>