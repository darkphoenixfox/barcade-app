<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
	<script>
		if (localStorage.theme === 'dark') {
			document.documentElement.classList.add('dark');
		}
	</script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			darkMode: 'class'
		}
	</script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Barcade Dashboard</title>
	<script src="https://unpkg.com/htmx.org@1.9.10" defer></script>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>

	<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
	<link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">
	<link rel="apple-touch-icon" href="/static/apple_touch_icon.png">
	<link rel="shortcut icon" href="/static/favicon-32x32.png">

</head>

<body class="bg-gray-100 dark:bg-gray-900 text-black dark:text-white min-h-screen font-sans">
	<header class="bg-blue-800 dark:bg-blue-950 text-white p-4 shadow
               relative min-h-14
               flex flex-col gap-2
               sm:flex-row sm:items-center sm:gap-4">
		<div class="flex items-center h-8">
		{% if has_logo %}
			<img src="/static/images/logo.png" alt="Barcade Logo" class="h-8 w-auto">
		{% else %}
			<h1 class="text-xl font-semibold">Barcade Management</h1>
		{% endif %}
		</div>
		<div id="location-selector-container"
			class="w-full sm:w-auto"
			hx-get="/location-selector"
			hx-trigger="load"
			hx-swap="innerHTML">
		</div>

		<div class="flex-grow"></div>

		<div class="flex items-center gap-4 flex-wrap justify-end">
		{% if user %}
		<div class="flex items-baseline gap-2">
			<span class="font-semibold leading-none whitespace-nowrap">{{ user.name }}</span>
			<span class="text-xs font-semibold uppercase leading-none whitespace-nowrap
				{% if user.role.value == 'admin' %} text-red-500 dark:text-red-400
				{% elif user.role.value == 'user' %}  text-green-500 dark:text-green-400
				{% else %}                           text-gray-400
				{% endif %}
			">
				{% if user.role.value == "admin" %}ADMIN{% else %}{{ user.role.value|upper }}{% endif %}
			</span>
		</div>
			{% if user.role.value == "admin" %}
			<button
				id="settings-button"
				hx-get="/settings/modal"
				hx-target="#modal-container"
				hx-swap="innerHTML"
				class="h-8 inline-flex items-center px-3 rounded ml-2 font-semibold text-sm bg-white text-blue-800 hover:bg-gray-200">
				Settings
			</button>
			{% endif %}
			<a id="logout-button" href="/logout"
			class="h-8 inline-flex items-center px-3 rounded ml-2 font-semibold text-sm bg-white text-blue-800 hover:bg-gray-200">
			Logout
			</a>

			{% else %}
			<form method="post" action="/login" id="login-form" class="flex items-center">
			<input name="pin" id="pin-input" type="password" placeholder="PIN"
				maxlength="4" autofocus
				class="h-8 w-20 text-center px-2 rounded text-black text-sm leading-none" required>
			</form>
			{% endif %}

			<button id="help-button" class="text-white hover:text-gray-300 text-xl ml-4">
				<i class="fa-solid fa-circle-question"></i>
			</button>

			<button onclick="toggleDarkMode()" class="text-white hover:text-gray-300 text-xl ml-4">
				<i class="fa-solid fa-moon block dark:hidden"></i>
				<i class="fa-solid fa-sun hidden dark:block"></i>
			</button>
		</div>
	</header>
	<main class="p-6">
		{% block content %}{% endblock %}
	</main>
	<div id="toast"
     class="absolute right-4 mt-4 space-y-2 pointer-events-none"
     style="top: 4rem;">
	</div>
	<div id="modal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

	<script>
	document.addEventListener("DOMContentLoaded", function() {
		
		// --- Helper Functions ---
		window.toggleDarkMode = function() {
			const html = document.documentElement;
			const isDark = html.classList.contains('dark');

			if (isDark) {
				html.classList.remove('dark');
				localStorage.theme = 'light';
			} else {
				html.classList.add('dark');
				localStorage.theme = 'dark';
			}
		}

		window.showToast = function(message) {
			const wrap = document.getElementById('toast');
			const el = document.createElement('div');
			el.className = "pointer-events-auto bg-green-600 text-white px-4 py-2 rounded shadow";
			el.textContent = message || "Saved";
			wrap.appendChild(el);
			setTimeout(() => {
				el.classList.add('opacity-0');
				el.classList.add('transition-opacity');
				setTimeout(() => el.remove(), 300);
			}, 2000);
		}

		// --- Global Event Listeners ---
		
		// Modal & System Listeners
		document.addEventListener('keydown', function (event) {
			if (event.key === 'Escape') {
				const modal = document.getElementById('modal-container');
				if (modal) {
					modal.innerHTML = '';
				}
			}
		});

		document.addEventListener('close_modal', function () {
			const mc = document.getElementById('modal-container');
			if (mc) mc.innerHTML = '';
		});

		// HTMX-Specific Listeners
		document.body.addEventListener("htmx:afterSwap", function (evt) {
			if (evt.detail.target && evt.detail.target.id === "modal-container") {
				htmx.process(evt.detail.target);
			}
		});
		
		document.body.addEventListener('htmx:load', () => {
			const postReloadData = sessionStorage.getItem('postReload');
			if (postReloadData) {
				sessionStorage.removeItem('postReload');
				const data = JSON.parse(postReloadData);
				if (data.action === 'openSettings') {
					htmx.ajax('GET', '/settings/modal', '#modal-container');
				}
				setTimeout(() => {
					if (data.tab) {
						const tabButton = document.getElementById(`settings-tab-${data.tab}`);
						if (tabButton) tabButton.click();
					}
					if (data.toastMessage) showToast(data.toastMessage);
				}, 200);
			}
		});
		
		document.body.addEventListener('htmx:afterOnLoad', function (evt) {
			try {
				const xhr = evt.detail?.xhr;
				if (!xhr) return;
				const url = (xhr.responseURL || '');
				if (!url.includes('/game/') || !url.includes('/move')) return;

				const data = JSON.parse(xhr.responseText || '{}');
				if (data && (data.moved || data.swapped)) {
					showToast('Position updated');
				}
			} catch (e) { /* Fail silently */ }
		});

		// Custom Application Event Listeners (Post-Save Reloads)
		document.addEventListener('location_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = { action: 'openSettings', toastMessage: message };
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});

		document.addEventListener('game_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = { action: 'openSettings', toastMessage: message, tab: 'games' };
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});

		document.addEventListener('user_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = { action: 'openSettings', toastMessage: message, tab: 'users' };
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});
		
		document.addEventListener('category_saved', function (e) {
			const message = e.detail.message;
			const postReloadData = { action: 'openSettings', toastMessage: message, tab: 'categories' };
			sessionStorage.setItem('postReload', JSON.stringify(postReloadData));
			window.location.reload();
		});

		// Custom Application Event Listeners (Simple Toasts & Refreshes)
		document.addEventListener('settings_saved', (e) => showToast(e.detail?.message || "Settings saved"));
		document.addEventListener('revenue_logged', (e) => showToast(e.detail?.message || 'Revenue logged'));
		document.addEventListener('status_changed', (e) => showToast(e.detail?.message || 'Status updated'));
		
		document.addEventListener('refresh_grid', function () {
			const grid = document.getElementById('grid');
			if (grid) {
				htmx.ajax('GET', '/grid-fragment', '#grid').then(() => htmx.process(grid));
			}
		});
		
		// --- Initializers ---

		// Auto-submit PIN form
		const pinInput = document.getElementById("pin-input");
		const loginForm = document.getElementById("login-form");
		if (pinInput && loginForm) {
			pinInput.addEventListener("input", function() {
				if (this.value.length === 4) loginForm.submit();
			});
		}

		// Shepherd Guided Tour Logic
		const helpButton = document.getElementById('help-button');
		if (helpButton) {
			const tour = new Shepherd.Tour({
				useModalOverlay: true,
				defaultStepOptions: {
					classes: 'shadow-md bg-blue-600 text-white',
					scrollTo: true,
					cancelIcon: { enabled: true },
					popperOptions: { modifiers: [{ name: 'offset', options: { offset: [0, 8] } }] }
				},
			});

			{% if not user %}
				tour.addStep({
					title: 'Welcome!',
					text: 'Enter your 4-digit PIN here to log in.',
					attachTo: { element: '#pin-input', on: 'bottom' },
					buttons: [{ text: 'Got it', action: tour.complete }]
				});
			{% else %}
				let firstGameTile = null;
				const allGameTiles = document.querySelectorAll('.game-tile');
				if (allGameTiles.length > 0) {
					firstGameTile = [...allGameTiles].reduce((topLeft, current) => {
						const topLeftY = parseInt(topLeft.dataset.y, 10);
						const currentY = parseInt(current.dataset.y, 10);
						if (currentY < topLeftY) return current;
						if (currentY === topLeftY) {
							const topLeftX = parseInt(topLeft.dataset.x, 10);
							const currentX = parseInt(current.dataset.x, 10);
							if (currentX < topLeftX) return current;
						}
						return topLeft;
					});
				}

				if (firstGameTile) {
					tour.addStep({
						title: 'Game Grid',
						text: 'You can drag and drop games to rearrange their positions on the grid.',
						attachTo: { element: firstGameTile, on: 'bottom' },
						buttons: [{ text: 'Next', action: tour.next }]
					});
					tour.addStep({
						title: 'Game Details',
						text: 'Double-click on any game to open its details, log revenue, or report an issue.',
						attachTo: { element: firstGameTile, on: 'bottom' },
						buttons: [{ text: 'Next', action: tour.next }]
					});
				} else if (document.getElementById('grid')) {
					let gridHelpText = 'This is where your games will appear. Once added, you can drag them to change their position or double-click to see details.';
					{% if user.role.value == "admin" %}
						gridHelpText += ' To get started, add a new game from the <strong>Settings</strong> menu.';
					{% endif %}
					tour.addStep({
						title: 'Your Game Grid',
						text: gridHelpText,
						attachTo: { element: '#grid', on: 'bottom' },
						buttons: [{ text: 'Next', action: tour.next }]
					});
				}

				tour.addStep({
					title: 'Switch Locations',
					text: 'Use this dropdown menu to view the game grid for a different location.',
					attachTo: { element: '#location-selector-container', on: 'bottom' },
					buttons: [{ text: 'Next', action: tour.next }]
				});

				{% if user.role.value == "admin" %}
				tour.addStep({
					title: 'Admin Settings',
					text: 'As an administrator, you can use the settings panel to manage games, locations, users, and categories.',
					attachTo: { element: '#settings-button', on: 'bottom' },
					buttons: [{ text: 'Next', action: tour.next }]
				});
				{% endif %}

				tour.addStep({
					title: 'Log Out',
					text: 'Click here to log out of the system.',
					attachTo: { element: '#logout-button', on: 'bottom' },
					buttons: [{ text: 'Finish', action: tour.complete }]
				});
			{% endif %}

			helpButton.addEventListener('click', () => {
				tour.start();
			});
		}
	});
	</script>
</body>
</html>